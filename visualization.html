<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Naive Bayes Visualization</title>
  <link href="primary.css" rel="stylesheet">
  <meta charset="utf-8" />
</head>
<script src="http://d3js.org/d3.v3.min.js" type="text/javascript">
</script>
<body onload="spreadsheet2();">
<p class="title">Naive Bayes Visualization</p>
<div id="controls">
  <div id="buttons" />
</div>
  <footer>
<script>

function spreadsheet2() {
      d3.json("data/zoo-modified.json",function(error,data) {
        expData=data;
        createSpreadsheet(data)
      });

      var class2 = {};
      var class4 = {};

      function createSpreadsheet(incData) {
        var keyValues = d3.keys(incData[0])

        d3.select("#controls")
        .append("div")
        .attr("class", "table")

        d3.select("div.table")
        .append("div")
        .attr("class", "head")
        .selectAll("div.data")
        .data(keyValues)
        .enter()
        .append("div")
        .attr("class", "data")
        .html(function (d) {
          return d
        })
        .style("left", function(d,i) {return (i * 86) + "px"});

        d3.select("div.table")
        .selectAll("div.datarow")
        .data(incData, function(d) {return d.animal}).enter()
        .append("div")
        .attr("class", "datarow")
        .style("top", function(d,i) {return (40 + (i * 40)) + "px"});

        d3.selectAll("div.datarow")
        .selectAll("div.data")
        .data(function(d) {return d3.entries(d)})
        .enter()
        .append("div")
        .attr("class", "data")
        .html(function (d) {return d.value})
        .style("left", function(d,i,j) {return (i * 86) + "px"});

        d3.select("#controls #buttons").insert("div", "#button1").on("click", highlightClasses).html("1");
        d3.select("#controls #buttons").insert("div", "#button2").on("click", sortSheet).html("2");
        d3.select("#controls #buttons").insert("div", "#button3").on("click", mergeRows).html("3");
        d3.select("#controls #buttons").insert("div", "#button4").on("click", generateProbabilities).html("4");
        d3.select("#controls #buttons").insert("div", "#button5").on("click", stackedBar).html("5");

        // Not used, but arranges the rows back to normal
        function transitionSheet() {
          d3.selectAll("div.datarow")
            .transition()
            .duration(2000)
            .style("top", function(d,i) {return (40 + (i * 40)) + "px"});
        }

        // Sorts by class
        function sortSheet() {
          var dataset = d3.selectAll("div.datarow").data();

          dataset.sort(function(a,b) {
            return a.class > b.class;
          });

          d3.selectAll("div.datarow").data(dataset, function(d) {
            return d.animal
          })
          .transition()
          .duration(2000)
          .style("top", function(d,i) {return (40 + (i * 40))});
        }

        // Highlight the class columns
        function highlightClasses() {
          d3.selectAll("div.datarow")
          .selectAll("div.data")
          .each(function (d, i) {
            if(i % 16 === 0){
              if(d.value === 2) {
                d3.select(this).attr("class", "data blue-class");
              } else if(d.value === 4){
                d3.select(this).attr("class", "data orange-class");
              }
            }
          });
        }

        // Merges the rows of the table
        function mergeRows() {
          var dataset = d3.selectAll("div.datarow").data();

          // Get sums
          d3.nest().key(function(d){
              return d.class;
          })
          .rollup(function(v){
            if(v[0].class === 2){class2.len = v.length;}
            if(v[0].class === 4){class4.len = v.length;}

            return {
                animal: v.animal,
                hair: d3.sum(v, function(d){return d.hair;}),
                feathers: d3.sum(v, function(d){return d.feathers;}),
                eggs: d3.sum(v, function(d){return d.eggs;}),
                milk: d3.sum(v, function(d){return d.milk;}),
                airborne: d3.sum(v, function(d){return d.airborne;}),
                aquatic: d3.sum(v, function(d){return d.aquatic;}),
                predator: d3.sum(v, function(d){return d.predator;}),
                toothed: d3.sum(v, function(d){return d.toothed;}),
                backbone: d3.sum(v, function(d){return d.backbone;}),
                breathes: d3.sum(v, function(d){return d.breathes;}),
                venomous: d3.sum(v, function(d){return d.venomous;}),
                fins: d3.sum(v, function(d){return d.fins;}),
                tail: d3.sum(v, function(d){return d.tail;}),
                domestic: d3.sum(v, function(d){return d.domestic;}),
                catsize: d3.sum(v, function(d){return d.catsize;}),
                class: v.class
              }
          }).entries(dataset)
          .map(function(d){
              if(d.key === "2") {
                class2.vals = Object.values(d.values);
              } else if (d.key === "4") {
                class4.vals = Object.values(d.values);
              }
          });

          // Remove animal from header
          d3.select('div.head div:first-child').text('');

          // Merge all the class 2 rows to one location
          d3.selectAll("div.datarow").data(dataset, function(d) {
            if(d.class === 2) {
              return d.animal
            }
          })
          .transition()
          .duration(2000)
          .style("top", 40);

          // Change merged row values to sums
          d3.selectAll("div.datarow").data(dataset, function(d) {
            if(d.animal === 'mole') {
              return d.animal
            }
          })
          .selectAll("div.data")
          .each(function (d, i) {
            d3.select(this).text(class2.vals[i]);
            if(i === class2.vals.length - 1) {
              d3.select(this).text(2);
            } else if(i === 0) {
              d3.select(this).text('count');
            }
          });

          // Merge all the class 4 rows to one location
          d3.selectAll("div.datarow").data(dataset, function(d) {
            if(d.class === 4) {
              return d.animal
            }
          })
          .transition()
          .duration(2000)
          .style("top", 80);

          // Change merged row values to sums
          d3.selectAll("div.datarow").data(dataset, function(d) {
            if(d.animal === 'skimmer') {
              return d.animal
            }
          })
          .selectAll("div.data")
          .each(function (d, i) {
            d3.select(this).text(class4.vals[i]);
            if(i === class4.vals.length - 1) {
              d3.select(this).text(4);
            } else if(i === 0) {
              d3.select(this).text('count');
            }
          });
        }

        // Sums the rows and divides by the number of classes
        function generateProbabilities() {
          var dataset = d3.selectAll("div.datarow").data();

          class4.feature_probs = []
          class2.feature_probs = []

          d3.selectAll("div.datarow").data(dataset, function(d) {
            if(d.animal === 'skimmer') {
              return d.animal
            }
          })
          .selectAll("div.data")
          .each(function (d, i) {
            if(d3.select(this).text() != 'count' && i != 16) {
              var prob = (class4.vals[i]/class4.len).toFixed(2)
              class4.feature_probs.push(prob)
              d3.select(this).text(prob);
            }
          });

          d3.selectAll("div.datarow").data(dataset, function(d) {
            if(d.animal === 'mole') {
              return d.animal
            }
          })
          .selectAll("div.data")
          .each(function (d, i) {
            if(d3.select(this).text() != 'count' && i != 16) {
              var prob = (class2.vals[i]/class2.len).toFixed(2)
              class2.feature_probs.push(prob)
              d3.select(this).text(prob);
            }
          });
        }

        // Converts the probabilities into a stacked bar chart
        function stackedBar() {
          var dataset = d3.selectAll("div.datarow").data();

          d3.selectAll("div.datarow").data(dataset, function(d) {
            if(d.animal === 'skimmer') {
              return d.animal
            }
          })
          .attr("class", "datarow stacked-row")
          .style("top", 280 + "px")
          .selectAll("div.data")
          .each(function (d, i) {
            if(d3.select(this).text() != 'count' && i != 16) {
              height = parseFloat(class4.feature_probs[i-1])/(parseFloat(class4.feature_probs[i-1]) + parseFloat(class2.feature_probs[i-1]))*500;
              d3.select(this).style("height", height + "px");
              d3.select(this).style("line-height", height + "px");
              d3.select(this).attr("class", "data stacked-orange-data");
            } else {
              d3.select(this).attr("class", "data bye-data");
            }
          });

          d3.selectAll("div.datarow").data(dataset, function(d) {
            if(d.animal === 'mole') {
              return d.animal
            }
          })
          .attr("class", "datarow stacked-row")
          .selectAll("div.data")
          .each(function (d, i) {
            if(d3.select(this).text() != 'count' && i != 16) {
              height = parseFloat(class2.feature_probs[i-1])/(parseFloat(class4.feature_probs[i-1]) + parseFloat(class2.feature_probs[i-1]))*500;
              console.log(height);
              d3.select(this).style("height", height + "px");
              d3.select(this).style("line-height", height + "px");
              d3.select(this).attr("class", "data stacked-blue-data");
            } else {
              d3.select(this).attr("class", "data bye-data");
            }
          });
        }
      }
}

</script>
</footer>
</body>
</html>
